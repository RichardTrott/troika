# `troika-physics`
[![JavaScript Style Guide](https://img.shields.io/badge/code_style-standard-brightgreen.svg)](https://standardjs.com)

> TODO: description

## Usage

```
const troikaPhysics = require('troika-physics');

// TODO: DEMONSTRATE API
```

## About Ammo.js and Bullet Physics
ammo.js (the initial engine used for `troika-physics`) is a javascript port of the Bullet physics engine.

##### Resources:
* [Bullet Physics Manual](http://www.cs.kent.edu/~ruttan/GameEngines/lectures/Bullet_User_Manual)
* [Bullet API Documentation](https://pybullet.org/Bullet/BulletFull/index.html)
* [Bullet QuickStart Guide](https://docs.google.com/document/d/10sXEhzFRSnvFcl3XxNGhnD4N2SedqwdAvK3dsihxVUA/edit#heading=h.czaspku18mzs)
* [Great Resource for Collisions](https://github.com/AndresTraks/BulletSharp/wiki/Collision-Callbacks-and-Triggers)

## Roadmap/TODO
- [x] Rigid Bodies
  - [x] Instancing Support (via `InstanceableObject3DFacade`)
  - [x] `onCollision` events
- [x] Soft Bodies/Volumes (experimental)
  - [ ] Instancing Support
  - [ ] `onCollision` events
- [ ] Collision Filtering
- [ ] Constraints
- [ ] Collision Shape caching/sharing/manager
  - [ ] Generate new shape instances when `localScaling` is different from the cache.
- [x] Handle changes to `physics` properties (mass, restitution, friction, etc.) while simulation is running
- [x] Kinematic Bodies (use `isKinematic: true`)
- [x] Static Bodies (`isStatic: true`)
- [ ] CoM (Center of Mass) handling via `physics` configuration
- [ ] Simpler user-specified collider configuration
- [x] Inlined Ammo.js WASM engine, for simpler distribution
- [x] Custom Ammo.js build
- [ ] Fallback to ASM.js Ammo build if WASM is unsupported
- [ ] Automatic handling of Physics-extended Groups.
  - [ ] For `static` groups, generate a merged triangle mesh collider by recursively iterating over all child geometries
  - [x] For non-`static` groups, generate a Bullet compound shape, producing a single rigid body representing the 
- [ ] Height-field terrain
- [ ] RaycastVehicle 
- [ ] Ghost objects (trigger volumes)
- [ ] SharedArrayBuffer for soft body vertices/indices https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer
- [x] (possible) implementation of DebugDrawer to help diagnose collision shape issues. https://github.com/InfiniteLee/ammo-debug-drawer/blob/master/examples/index.html
  - [x] Will need to be re-added in the custom WASM AmmoJS build -- possible dev-only output?

## Known issues and limitations
- Ammo/Bullet `btCompoundShape` (generated by extending a group as physical) child shapes do *not* play nicely with Three/Troika scaling. A warning will be emitted to the console if child objects added to a Compound Shape are scaled.
- Compound shapes must be rigid bodies.

## External docs and useful information

### Ammo Soft Body configuration
Ammo/Bullet Soft Body `cfg` properties. Set via `cfg.set_<prop>(..args)`.
```
eAeroModel::_                   aeromodel;      // Aerodynamic model (default: V_Point)
btScalar                        kVCF;           // Velocities correction factor (Baumgarte)
btScalar                        kDP;            // Damping coefficient [0,1]
btScalar                        kDG;            // Drag coefficient [0,+inf]
btScalar                        kLF;            // Lift coefficient [0,+inf]
btScalar                        kPR;            // Pressure coefficient [-inf,+inf]
btScalar                        kVC;            // Volume conversation coefficient [0,+inf]
btScalar                        kDF;            // Dynamic friction coefficient [0,1]
btScalar                        kMT;            // Pose matching coefficient [0,1]              
btScalar                        kCHR;           // Rigid contacts hardness [0,1]
btScalar                        kKHR;           // Kinetic contacts hardness [0,1]
btScalar                        kSHR;           // Soft contacts hardness [0,1]
btScalar                        kAHR;           // Anchors hardness [0,1]
btScalar                        kSRHR_CL;       // Soft vs rigid hardness [0,1] (cluster only)
btScalar                        kSKHR_CL;       // Soft vs kinetic hardness [0,1] (cluster only)
btScalar                        kSSHR_CL;       // Soft vs soft hardness [0,1] (cluster only)
btScalar                        kSR_SPLT_CL;    // Soft vs rigid impulse split [0,1] (cluster only)
btScalar                        kSK_SPLT_CL;    // Soft vs rigid impulse split [0,1] (cluster only)
btScalar                        kSS_SPLT_CL;    // Soft vs rigid impulse split [0,1] (cluster only)
btScalar                        maxvolume;      // Maximum volume ratio for pose
btScalar                        timescale;      // Time scale
int                             viterations;    // Velocities solver iterations
int                             piterations;    // Positions solver iterations
int                             diterations;    // Drift solver iterations
int                             citerations;    // Cluster solver iterations
int                             collisions;     // Collisions flags
tVSolverArray                   m_vsequence;    // Velocity solvers sequence
tPSolverArray                   m_psequence;    // Position solvers sequence
tPSolverArray                   m_dsequence;    // Drift solvers sequence
```

### Emscripten settings
[https://github.com/emscripten-core/emscripten/blob/incoming/src/settings.js](https://github.com/emscripten-core/emscripten/blob/incoming/src/settings.js)